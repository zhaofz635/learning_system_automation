name: Textbook Analysis Pipeline

on:
  workflow_dispatch:
    inputs:
      student_id:
        description: 'å­¦ç”ŸID (å¦‚ test001)'
        required: true
        type: string
      score:
        description: 'æµ‹è¯•æˆç»© (0-5åˆ†)'
        required: true
        type: string
      cognitive_load:
        description: 'è®¤çŸ¥è´Ÿè·è¯„åˆ† (1-5åˆ†ï¼Œé€—å·åˆ†éš”)'
        required: true
        type: string

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1. æ£€å‡ºä»£ç 
      - uses: actions/checkout@v4

      # 2. è®¾ç½® Python ç¯å¢ƒï¼ˆç¡®ä¿ pip æŒ‡å‘æ­£ç¡®è·¯å¾„ï¼‰
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      # 3. éªŒè¯å½“å‰ Python å’Œ pip
      - name: Verify Python & pip
        run: |
          which python
          which pip
          python --version
          pip --version
          pip list

      - name: Install Python packages
        run: |
          python -m pip install --upgrade pip
          python -m pip install \
            numpy<2.0.0 \
            scipy<2.0.0 \
            pandas==1.5.3 \
            scikit-learn==1.2.2 \
            xgboost==1.7.6 \
            opencv-python-headless==4.8.0.76 \
            nltk==3.7 \
            requests==2.31.0
          python -c "
          import requests
          print(f'âœ… Requests å®‰è£…æˆåŠŸï¼Œç‰ˆæœ¬: {requests.__version__}')
          import nltk
          print(f'âœ… NLTK å®‰è£…æˆåŠŸï¼Œç‰ˆæœ¬: {nltk.__version__}')
          import cv2
          print(f'âœ… OpenCV å®‰è£…æˆåŠŸï¼Œç‰ˆæœ¬: {cv2.__version__}')
          "


      # 5. ç¼“å­˜ NLTK æ•°æ®
      - name: Cache NLTK Data
        uses: actions/cache@v3
        with:
          path: /tmp/nltk_data
          key: ${{ runner.os }}-nltk-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-nltk-

      # 6. è®¾ç½® NLTK ç¯å¢ƒ
      - name: Setup NLTK
        run: |
          mkdir -p /tmp/nltk_data
          chmod -R 777 /tmp/nltk_data
          echo "NLTK_DATA=/tmp/nltk_data" >> $GITHUB_ENV

          python -c "
          import nltk
          import os
          nltk.download('punkt', download_dir=os.environ['NLTK_DATA'], quiet=False)
          nltk.download('punkt_tab', download_dir=os.environ['NLTK_DATA'], quiet=False)
          nltk.download('book', download_dir=os.environ['NLTK_DATA'], quiet=False)
          print('âœ… NLTK èµ„æºä¸‹è½½å®Œæˆ')
          "

      # 7. å‡†å¤‡è¾“å…¥æ•°æ®
      - name: Prepare input files
        run: |
          cognitive_load_array=$(echo "${{ inputs.cognitive_load }}" | tr ',' ' ')
          cat > input_data.json <<EOF
          {
            "student_id": "${{ inputs.student_id }}",
            "score": ${{ inputs.score }},
            "cognitive_load": [${cognitive_load_array// /,}]
          }
          EOF
          echo "ğŸ“„ è¾“å…¥æ–‡ä»¶å†…å®¹:"
          cat input_data.json

      # 8. è¿è¡Œåˆ†æè„šæœ¬
      - name: Run analysis
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
          NLTK_DATA: /tmp/nltk_data
        run: |
          # æœ€ç»ˆéªŒè¯
          python -c "
          import sys
          print(f'Python: {sys.version}')
          import numpy as np; print(f'NumPy: {np.__version__}')
          import cv2; print(f'OpenCV: {cv2.__version__}')
          import requests; print(f'Requests: {requests.__version__}')
          import nltk; print(f'NLTK: {nltk.__version__}')
          "

          # æ‰§è¡Œä¸»è„šæœ¬
          python textbook_difficulty_system.py \
            --cognitive_load input_data.json \
            --scores input_data.json \
            --textbook textbook.json \
            --output results.json

          echo "ğŸ“Š åˆ†æç»“æœ:"
          cat results.json

      # 9. æäº¤ç»“æœ
      - name: Commit results
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add results.json
          git commit -m "Auto: Results for ${{ inputs.student_id }} [skip ci]" || echo "No changes"
          git push

      # 10. ä¸Šä¼ åˆ° Google Sheets
      - name: Upload to Google Sheets
        if: success()
        continue-on-error: true
        env:
          GAS_SCRIPT_URL: ${{ secrets.GAS_WEBAPP_URL }}
        run: |
          curl --fail --show-error --retry 3 \
            -X POST "$GAS_SCRIPT_URL" \
            -H "Content-Type: application/json" \
            --data-binary @results.json

      # 11. é€šçŸ¥çŠ¶æ€
      - name: Notify status
        if: always()
        run: |
          echo "âœ… å·¥ä½œæµå®Œæˆï¼ŒçŠ¶æ€: ${{ job.status }}"
          echo "ğŸ”— æŸ¥çœ‹ç»“æœ: https://github.com/${{ github.repository }}/blob/main/results.json"
