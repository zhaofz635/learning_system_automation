name: Textbook Analysis Pipeline

on:
  workflow_dispatch:
    inputs:
      student_id:
        description: 'å­¦ç”ŸID (å¦‚ test001)'
        required: true
        type: string
      score:
        description: 'æµ‹è¯•æˆç»© (0-5åˆ†)'
        required: true
        type: string
      cognitive_load:
        description: 'è®¤çŸ¥è´Ÿè·è¯„åˆ† (1-5åˆ†ï¼Œé€—å·åˆ†éš”)'
        required: true
        type: string

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NLTK_DATA: /tmp/nltk_data  # å…¨å±€ç¯å¢ƒå˜é‡

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Create NLTK data directory
        run: |
          mkdir -p /tmp/nltk_data
          chmod -R 777 /tmp/nltk_data
          echo "NLTK_DATA=/tmp/nltk_data" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install nltk==3.8.1  # ç¨³å®šç‰ˆæœ¬

      - name: Download NLTK resources (include punkt_tab)
        run: |
          python -c "
          import nltk
          import os
          nltk.download('punkt', download_dir=os.environ['NLTK_DATA'])
          nltk.download('punkt_tab', download_dir=os.environ['NLTK_DATA'])
          nltk.download('averaged_perceptron_tagger', download_dir=os.environ['NLTK_DATA'])
          nltk.download('stopwords', download_dir=os.environ['NLTK_DATA'])
          nltk.download('wordnet', download_dir=os.environ['NLTK_DATA'])
          nltk.download('book', download_dir=os.environ['NLTK_DATA'])
          print('âœ… NLTKèµ„æºä¸‹è½½å®Œæˆ')
          "

      - name: Validate NLTK setup
        run: |
          python -c "
          import nltk, os
          nltk.data.path.insert(0, os.environ['NLTK_DATA'])
          print('ğŸ” NLTKè·¯å¾„:', nltk.data.path)
          print(nltk.data.find('tokenizers/punkt'))
          print(nltk.data.find('tokenizers/punkt_tab'))
          print(nltk.word_tokenize('Hello world. This is a test.'))
          print('âœ… NLTKéªŒè¯é€šè¿‡')
          "

      - name: Prepare input files
        run: |
          cognitive_load_array=$(echo "${{ inputs.cognitive_load }}" | tr ',' ' ')
          cat > input_data.json <<EOF
          {
            "student_id": "${{ inputs.student_id }}",
            "score": ${{ inputs.score }},
            "cognitive_load": [${cognitive_load_array// /,}]
          }
          EOF
          echo "è¾“å…¥æ–‡ä»¶å†…å®¹:"
          jq . input_data.json || cat input_data.json

      - name: Run analysis script
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
          NLTK_DATA: /tmp/nltk_data
        run: |
          python -c "import nltk; nltk.data.path.insert(0, '/tmp/nltk_data'); print(f'NLTKæ•°æ®è·¯å¾„: {nltk.data.path}')"
          python textbook_difficulty_system.py \
            --cognitive_load input_data.json \
            --scores input_data.json \
            --textbook textbook.json \
            --output results.json
          echo "åˆ†æç»“æœ:"
          jq . results.json || cat results.json

      - name: Commit results
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add results.json
          git commit -m "Auto: Results for ${{ inputs.student_id }} [skip ci]" || echo "æ— å˜æ›´å¯æäº¤"
          git push

      - name: Upload to Google Drive
        continue-on-error: true
        env:
          GAS_SCRIPT_URL: ${{ secrets.GAS_WEBAPP_URL }}
        run: |
          curl --fail --show-error --retry 3 \
            -X POST "$GAS_SCRIPT_URL" \
            -H "Content-Type: application/json" \
            --data-binary @results.json

      - name: Notify completion
        if: always()
        run: |
          echo "å·¥ä½œæµçŠ¶æ€: ${{ job.status }}"
          echo "ç»“æœæ–‡ä»¶: https://github.com/$GITHUB_REPOSITORY/blob/$GITHUB_REF/results.json"
