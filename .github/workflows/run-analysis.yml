name: Textbook Analysis Pipeline

on:
  workflow_dispatch:
    inputs:
      student_id:
        description: '学生ID (如 test001)'
        required: true
        type: string
      score:
        description: '测试成绩 (0-100分)'
        required: true
        type: string
      cognitive_load:
        description: '认知负荷评分 (1-5分，逗号分隔，8个值)'
        required: true
        type: string
      user_feedback:
        description: '学生反馈 (如"我觉得太难")'
        required: false
        type: string
        default: ''

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NLTK_DATA: /tmp/nltk_data
      VIRTUAL_ENV: ${{ github.workspace }}/.venv
      PATH: ${{ github.workspace }}/.venv/bin:$PATH  # 默认 PATH 更新（后续步骤若需会覆盖）

    steps:
      # 1. 检出代码
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 设置 Python 环境
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'  # 保留 pip 下载缓存

      # 3. 安装系统依赖（适配 Ubuntu 24.04）
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libopencv-dev \
            libgl1 \
            libgtk2.0-dev

      # 4. 缓存 NLTK 数据（不变）
      - name: Cache NLTK Data
        uses: actions/cache@v3
        with:
          path: /tmp/nltk_data
          key: ${{ runner.os }}-nltk-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-nltk-

      # 5. 缓存虚拟环境（新：缓存命中时跳过 pip install）
      - name: Cache virtual environment
        id: cache-venv
        uses: actions/cache@v4  # 使用 v4 提升性能
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ hashFiles('requirements.txt') }}-${{ env.pythonLocation }}

      # 6. 创建并安装依赖到 venv（仅当缓存未命中）
      - name: Set up virtual environment
        if: steps.cache-venv.outputs.cache-hit != 'true'
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r requirements.txt

      # 7. 激活 venv 并更新 PATH（确保后续步骤使用 venv）
      - name: Activate virtual environment
        run: |
          echo "PATH=$VIRTUAL_ENV/bin:$PATH" >> $GITHUB_ENV
          echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV

      # 8. 验证安装（使用 venv）
      - name: Verify Python packages
        run: |
          python -c "
          import sys
          print('Python路径:', sys.executable)
          print('系统路径:', sys.path)
          
          try:
              import numpy as np
              print(f'NumPy版本: {np.__version__}')
              import cv2
              print(f'✅ OpenCV加载成功，版本: {cv2.__version__}')
              import requests
              print(f'✅ Requests加载成功，版本: {requests.__version__}')
              import xgboost
              print(f'✅ XGBoost加载成功，版本: {xgboost.__version__}')
              import sklearn
              print(f'✅ Scikit-Learn加载成功，版本: {sklearn.__version__}')
              import skimage
              print(f'✅ Scikit-Image加载成功，版本: {skimage.__version__}')
              import pandas
              print(f'✅ Pandas加载成功，版本: {pandas.__version__}')
              import scipy
              print(f'✅ SciPy加载成功，版本: {scipy.__version__}')
              import nltk
              print(f'✅ NLTK加载成功，版本: {nltk.__version__}')
          except Exception as e:
              print(f'❌ 导入失败: {str(e)}')
              raise
          "

      # 9. 设置 NLTK 环境（加条件检查避免重复下载）
      - name: Setup NLTK
        run: |
          mkdir -p /tmp/nltk_data
          chmod -R 777 /tmp/nltk_data
          echo "NLTK_DATA=/tmp/nltk_data" >> $GITHUB_ENV

          python -c "
          import nltk, os
          def download_if_missing(resource):
              path = os.path.join(os.environ['NLTK_DATA'], resource)
              if not os.path.exists(path):
                  nltk.download(resource, download_dir=os.environ['NLTK_DATA'], quiet=False)
              else:
                  print(f'{resource} 已存在，跳过下载')
          
          download_if_missing('punkt')
          download_if_missing('punkt_tab')
          download_if_missing('stopwords')
          print('✅ 关键NLTK资源已处理')
          "

      # 10. 准备输入数据（不变，自动使用 venv）
      - name: Prepare input files
        run: |
          cognitive_load_array=$(echo "${{ inputs.cognitive_load }}" | tr ',' ' ')
          cat > input_data.json <<EOF
          [
            {
              "student_id": "${{ inputs.student_id }}",
              "score": ${{ inputs.score }},
              "cognitive_load": [${cognitive_load_array// /,}],
              "user_feedback": "${{ inputs.user_feedback }}"
            }
          ]
          EOF
          echo "输入文件内容:"
          jq . input_data.json || cat input_data.json

      # 11 “‘运行分析脚本（不变，自动使用 venv）
      - name: Run analysis
        env:
          ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
          NLTK_DATA: /tmp/nltk_data
        run: |
          # 最终环境验证
          python -c "
          import sys, numpy as np, cv2, requests, xgboost, sklearn, skimage, pandas, scipy, nltk
          print(f'Python: {sys.version}')
          print(f'NumPy: {np.__version__}')
          print(f'OpenCV: {cv2.__version__}')
          print(f'Requests: {requests.__version__}')
          print(f'XGBoost: {xgboost.__version__}')
          print(f'Scikit-Learn: {sklearn.__version__}')
          print(f'Scikit-Image: {skimage.__version__}')
          print(f'Pandas: {pandas.__version__}')
          print(f'SciPy: {scipy.__version__}')
          print(f'NLTK: {nltk.__version__}')
          "
          
          # 带重试的运行机制
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "尝试第 $attempt 次运行..."
            python textbook_difficulty_system.py \
              --cognitive_load input_data.json \
              --scores input_data.json \
              --textbook textbook.json \
              --output results.json && break
            attempt=$((attempt + 1))
            sleep 5
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "❌ 运行失败，已达最大尝试次数"
            exit 1
          fi
          
          echo "分析结果:"
          jq . results.json || cat results.json

      # 12. 提交结果（不变）
      - name: Commit results
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add results.json
          git commit -m "Auto: Results for ${{ inputs.student_id }} [skip ci]" || echo "无变更可提交"
          git pull --rebase origin main
          remote_repo="https://${GITHUB_ACTOR}:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git"
          git push "${remote_repo}" HEAD:main || exit 0

      # 13. 上传到 Google Sheets（不变）
      - name: Upload to Google Sheets
        continue-on-error: true
        env:
          GAS_SCRIPT_URL: ${{ secrets.GAS_WEBAPP_URL }}
        run: |
          curl --fail --show-error --retry 3 \
            -X POST "$GAS_SCRIPT_URL" \
            -H "Content-Type: application/json" \
            --data-binary @results.json

      # 14. 最终状态通知（不变）
      - name: Notify status
        if: always()
        run: |
          echo "工作流状态: ${{ job.status }}"
          echo "结果文件: https://github.com/${GITHUB_REPOSITORY}/blob/${GITHUB_REF}/results.json"
          echo "详细日志: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
