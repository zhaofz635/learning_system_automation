name: Textbook Analysis Pipeline

on:
  workflow_dispatch:
    inputs:
      student_id:
        description: 'å­¦ç”ŸID (å¦‚ test001)'
        required: true
        type: string
      score:
        description: 'æµ‹è¯•æˆç»© (0-100åˆ†)'
        required: true
        type: string
      cognitive_load:
        description: 'è®¤çŸ¥è´Ÿè·è¯„åˆ† (1-5åˆ†ï¼Œé€—å·åˆ†éš”ï¼Œ8ä¸ªå€¼)'
        required: true
        type: string
      user_feedback:
        description: 'å­¦ç”Ÿåé¦ˆ (å¦‚"æˆ‘è§‰å¾—å¤ªéš¾")'
        required: false
        type: string
        default: ''

jobs:
  analyze:
    # ä½¿ç”¨ä½ æ¨é€çš„é•œåƒï¼Œè·³è¿‡æ‰€æœ‰å®‰è£…
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zhaofz635/learning_system_automation:textbook-pipeline
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆä¸ºäº†è¯»å–è¾“å…¥å’Œæäº¤ç»“æœï¼‰
      - uses: actions/checkout@v4

      # 2. å‡†å¤‡è¾“å…¥æ•°æ®
      - name: Prepare input files
        run: |
          cognitive_load_array=$(echo "${{ inputs.cognitive_load }}" | tr ',' ' ')
          cat > input_data.json <<EOF
          [
            {
              "student_id": "${{ inputs.student_id }}",
              "score": ${{ inputs.score }},
              "cognitive_load": [${cognitive_load_array// /,}],
              "user_feedback": "${{ inputs.user_feedback }}"
            }
          ]
          EOF
          echo "ğŸ“„ è¾“å…¥æ–‡ä»¶å·²ç”Ÿæˆ:"
          cat input_data.json
        shell: bash
      # - name: Prepare input files
      #   run: |
      #     cognitive_load_array=$(echo "${{ inputs.cognitive_load }}" | tr ',' ' ')
      #     cat > input_data.json <<EOF
      #     [
      #       {
      #         "student_id": "${{ inputs.student_id }}",
      #         "score": ${{ inputs.score }},
      #         "cognitive_load": [${cognitive_load_array// /,}],
      #         "user_feedback": "${{ inputs.user_feedback }}"
      #       }
      #     ]
      #     EOF
      #     echo "ğŸ“„ è¾“å…¥æ–‡ä»¶å·²ç”Ÿæˆ:"
      #     cat input_data.json

      # 3. ç›´æ¥è¿è¡Œåˆ†æè„šæœ¬ï¼ˆæ— éœ€å®‰è£…ï¼ï¼‰
      - name: Run analysis
        env:
          ACCESS_KEY_SECRET: ${{ secrets.ACCESS_KEY_SECRET }}
        run: |
          echo "ğŸ” å¼€å§‹è¿è¡Œ textbook_difficulty_system.py"
          python textbook_difficulty_system.py \
            --cognitive_load input_data.json \
            --scores input_data.json \
            --textbook textbook.json \
            --output results.json
          echo "âœ… åˆ†æå®Œæˆ"
          cat results.json

      # 4. æäº¤ç»“æœåˆ° GitHub
            # 4. æäº¤ç»“æœåˆ° GitHub
      - name: Commit results
        run: |
          # å‘Šè¯‰ Git ä¿¡ä»»è¿™ä¸ªç›®å½•ï¼ˆå…³é”®ï¼ï¼‰
          git config --global --add safe.directory /__w/learning_system_automation/learning_system_automation

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add results.json
          git commit -m "Auto: Results for ${{ inputs.student_id }} [skip ci]" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main || true
      # - name: Commit results
      #   run: |
      #     git config --global user.name "GitHub Actions"
      #     git config --global user.email "actions@github.com"
      #     git add results.json
      #     git commit -m "Auto: Results for ${{ inputs.student_id }} [skip ci]" || echo "No changes to commit"
      #     git pull --rebase origin main || true
      #     git push "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main || true

      # 5. ä¸Šä¼ åˆ° Google Sheetsï¼ˆå¯é€‰ï¼‰
      - name: Upload to Google Sheets
        continue-on-error: true
        env:
          GAS_SCRIPT_URL: ${{ secrets.GAS_WEBAPP_URL }}
        run: |
          curl --fail --show-error --retry 3 \
            -X POST "$GAS_SCRIPT_URL" \
            -H "Content-Type: application/json" \
            --data-binary @results.json

      # 6. é€šçŸ¥çŠ¶æ€
      - name: Notify status
        if: always()
        run: |
          echo "å·¥ä½œæµçŠ¶æ€: ${{ job.status }}"
          echo "ç»“æœæ–‡ä»¶: https://github.com/${{ github.repository }}/blob/main/results.json"
